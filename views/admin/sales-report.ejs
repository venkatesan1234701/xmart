<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Report</title>

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <link rel="stylesheet" href="../assets/css/theme.min.css">

  <style>
    /* =====================================================
   SALES REPORT ‚Äì FINAL RESPONSIVE FIX
   (CSS ONLY | SAFE | NO HTML/JS CHANGE)
===================================================== */

body {
  overflow-x: hidden;
}

/* ================= SIDEBAR (MOBILE) ================= */
@media (max-width: 768px) {
  aside {
    transform: translateX(-100%);
    transition: 0.3s ease;
    z-index: 60;
  }

  aside.open {
    transform: translateX(0);
  }

  #menuBtn {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 100;
  }

  .pt-6.pt-20.min-h-screen {
    margin-left: 0 !important;
    width: 100% !important;
    padding-top: 80px !important;
  }
}

/* ================= SUMMARY CARDS ================= */
@media (max-width: 768px) {
  .row.mb-4 {
    flex-direction: column;
    gap: 12px;
  }

  .card {
    padding: 1.25rem;
  }

  .card-text.display-6 {
    font-size: 1.6rem !important;
  }
}

/* ================= FILTER SECTION ================= */
@media (max-width: 768px) {
  .filter-section {
    padding: 1rem;
  }

  .date-filter-container,
  .time-filter-container {
    flex-direction: column;
    gap: 10px;
  }

  .date-input-group,
  .time-select-group {
    width: 100%;
    min-width: unset;
  }

  .button-group {
    flex-direction: column;
    gap: 8px;
  }

  .button-group .btn {
    width: 100%;
  }
}

/* ================= TABLE WRAPPER ================= */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* ================= TABLE BASE ================= */
.table {
  width: 100%;
  min-width: 900px; /* üî• important for scroll */
  border-collapse: collapse;
}

/* ================= TABLE CELLS ================= */
.table th,
.table td {
  white-space: nowrap;
  font-size: 14px;
  vertical-align: middle;
}

/* Name column */
.table td:nth-child(2) {
  min-width: 180px;
  white-space: normal;
}

/* Product column */
.table td:nth-child(4) {
  min-width: 220px;
  white-space: normal;
}

/* ================= MOBILE CARD VIEW ================= */
@media (max-width: 576px) {
  .table {
    min-width: 850px;
  }

  thead {
    display: none;
  }

  tbody tr {
    display: block;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    margin-bottom: 12px;
    padding: 10px;
    background: #fff;
  }

  tbody td {
    display: flex;
    justify-content: space-between;
    padding: 8px 6px;
    text-align: left !important;
  }

  tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #6b7280;
    padding-right: 8px;
  }
}

/* ================= DOWNLOAD BUTTONS ================= */
@media (max-width: 640px) {
  #download-pdf,
  #download-csv,
  #download-xlsx {
    width: 100%;
  }
}

/* ================= NO DATA MESSAGE ================= */
#no-data {
  margin-top: 16px;
  font-size: 15px;
}

    * {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    :root {
  --primary: #16a34a;
  --primary-dark: #059669;
  --bg-main: #f5f7fa;
  --sidebar-bg: #ffffff;
  --danger: #dc2626;
}



    @media (max-width: 640px) {
  aside {
    transform: translateX(-100%);
    transition: 0.3s;
  }

  aside.open {
    transform: translateX(0);
  }

  main {
    margin-left: 0 !important;
    width: 100% !important;
  }
}

    body {
      background: linear-gradient(135deg, #f6f8fd 0%, #ffffff 100%);
      color: #2d3748;
      overflow-x: hidden;
      min-height: 100vh;
    }


    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
      margin-top: 60px; /* Adjust based on navbar height */
    }

    .row.mb-4 {
      display: flex;
      gap: 2rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 2rem;
      flex: 1;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card.border-primary { border-left: 4px solid #4299e1; }
    .card.border-success { border-left: 4px solid #48bb78; }

    .card-title {
      color: #718096;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }

    .card-text.display-6 {
      font-size: 2.25rem;
      font-weight: 700;
      color: #2d3748;
    }

    .filter-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .filter-section .date-filter-container,
    .filter-section .time-filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .date-input-group, .time-select-group {
      flex: 1;
      min-width: 200px;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .form-control, .form-select {
      width: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 0.875rem;
    }

    .form-control:focus, .form-select:focus {
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      outline: none;
    }

    .btn {
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      min-width: 120px;
      text-align: center;
    }

    .btn-success { background: #48bb78; color: white; border: none; }
    .btn-success:hover { background: #38a169; }
    .btn-info { background: #4299e1; color: white; border: none; }
    .btn-info:hover { background: #3182ce; }
    .btn-outline-secondary { background: #e53e3e; color: white; border: none; }
    .btn-outline-secondary:hover { background: #c53030; }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .table-responsive {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
      margin-top: 2rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    .table th {
      background: #2d3748;
      color: white;
      padding: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .table td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      color: #4a5568;
    }

    .table tbody tr:hover { background: #f7fafc; }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    @media (max-width: 768px) {
      .row.mb-4 { flex-direction: column; }
      .filter-section { padding: 1rem; }
      .table-responsive { margin: 1rem -0.5rem; border-radius: 0; }
    }
  </style>
</head>

<body>


  
<button id="menuBtn"
  class="md:hidden px-3 py-2 bg-green-600 text-white rounded">
  ‚ò∞
</button>


    <aside class="fixed top-0 left-0 h-screen w-64 bg-white shadow-lg z-40">
  
  <!-- Logo -->
  <div class="flex items-center justify-center h-16 border-b">
    <img src="../assets/images/logo/Xe mart.png" class="h-10" />
  </div>

  <!-- Menu -->
  <ul class="flex flex-col gap-2 p-4">

    <li>
      <a href="/admin/dashboard"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üè† <span>Dashboard</span>
      </a>
    </li>

    <li>
      <a href="/admin/products"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üõí <span>Products</span>
      </a>
    </li>

    <li>
      <a href="/admin/categories"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üìÇ <span>Categories</span>
      </a>
    </li>

    <li>
      <a href="/admin/customers"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üë• <span>Customers</span>
      </a>
    </li>

    <li>
      <a href="/admin/orders"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üì¶ <span>Orders</span>
      </a>
    </li>

    <li>
      <a href="/admin/coupons"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üéüÔ∏è <span>Coupons</span>
      </a>
    </li>

    <li>
      <a href="/admin/product-offer"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üí∏ <span>Product Offer</span>
      </a>
    </li>

    <li>
      <a href="/admin/category-offer"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üè∑Ô∏è <span>Category Offer</span>
      </a>
    </li>

    <li>
      <a href="/admin/sales-report"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üìä <span>Sales Report</span>
      </a>
    </li>

    <li class="mt-6">
      <a href="/admin/logout"
         class="flex items-center gap-3 p-2 rounded text-red-600 hover:bg-red-100">
        üö™ <span>Logout</span>
      </a>
    </li>

  </ul>
</aside>

  <div class="main-wrapper">
    
  </div>

  <!-- Main Content -->
  <div class="pt-6 pt-20 min-h-screen overflow-y-auto"
  style="margin-left:14rem; width:calc(100% - 16rem);">
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-primary" style="padding: 1.5rem;">
        <div class="card-body text-center">
          <h5 class="card-title">Overall Order Amount</h5>
          <!-- <p class="card-text display-6" style="font-size: 2rem;">‚Çπ<%=totalOrderRevenue%></p> -->
           
           <p class="card-text display-6" style="font-size: 2rem;">‚Çπ<%= totalEarnings.toLocaleString('en-IN') %></p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
  <div class="card border-success" style="padding: 1.5rem;">
    <div class="card-body text-center">
      <h5 class="card-title">Discount</h5>
      <p class="card-text display-6" style="font-size: 2rem;">‚Çπ<%= totalDiscount %></p>
    </div>
  </div>
</div>

  </div>

  <div class="toast-container"></div>

  <!-- Filter Section -->
  <div class="filter-section">
 <form id="date-wise-filter">
  <div class="date-filter-container">
    <div class="date-input-group">
      <label for="from">From</label>
      <!-- <input type="date" class="form-control" id="startDate" name="from"> -->
       <input type="date" class="form-control" id="startDate" name="from">
    </div>
    <div class="date-input-group">
      <label for="to">To</label>
      <!-- <input type="date" class="form-control" id="endDate" name="to">
        -->
      <input type="date" class="form-control" id="endDate" name="to">
    </div>
    <div class="date-input-group" style="flex: 0.5;">
      <label>&nbsp;</label>
      <button class="btn btn-success">Apply Date</button>
    </div>
  </div>
</form>

    <div class="time-filter-container">
  <form id="plan-view" class="time-select-group">
   <label for="timePeriod">Time Period</label>
  <select id="timePeriod" class="form-select" name="timePeriod">
    <option value="" disabled selected>Select</option>
    <option value="week">Week</option>
    <option value="month">Month</option>
    <option value="year">Year</option>
  </select>
</form>
      <div class="button-group">
         <div style="margin-top: 10px;">
  <button id="filterBtn" class="btn btn-success" disabled>Filter</button>
</div>
        <!-- <button id="filterBtn" type="submit" class="btn btn-success" disabled>Filter</button> 
        <button class="btn btn-outline-secondary" onclick="clearFilter()">Clear Filters</button>
        <button class="btn btn-info" id="download-pdf">Download (PDF)</button> -->

      
  <button class="btn btn-info" id="download-pdf">Download (PDF)</button>
  <button class="btn btn-success" id="download-csv">Download (Excel - CSV)</button>
  <button class="btn btn-outline-secondary" onclick="clearFilter()">Clear Filters</button>
  <!-- XLSX (real .xlsx) -->
  <button class="btn btn-primary" id="download-xlsx">Download (Excel - XLSX)</button>

      </div>
    </div>
  </div>



<!-- <div class="table-responsive">
  <table class="table" id="ordersTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Name</th>
        <th>Delivery Date</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Total</th>
        <th>Payment Method</th>
      </tr>
    </thead>
    <tbody>
      <% orders.forEach((order, i) => { %>

        <tr data-order-date="<%= order.orderDate %>" data-order-status="<%= order.orderStatus %>">
          <td><%= i + 1 %></td>
          <td><%= order.userName %></td>
      
           <td><%= new Date(order.orderDate).toISOString().split("T")[0] %></td>

          <td><%= order.productName %></td>
          <td><%= order.quantity %></td>
          <td>‚Çπ<%= order.grandTotal %></td>
          <td><%= order.paymentMethod %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div> -->


<div class="table-responsive">
  <table class="table" id="ordersTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Name</th>
        <th>Delivery Date</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Total</th>
        <th>Discount</th>   
        <th>Payment Method</th>
      </tr>
    </thead>

    <tbody>
      <% orders.forEach((order, i) => { %>
        <tr data-order-date="<%= order.orderDate %>" data-order-status="<%= order.orderStatus %>">
          <td><%= i + 1 %></td>
          <td><%= order.userName %></td>
          <td><%= new Date(order.orderDate).toISOString().split("T")[0] %></td>

          <td><%= order.productName %></td>
          <td><%= order.quantity %></td>

          <td><%= order.grandTotal %></td>

          <td><%= order.discount %></td>  

          <td><%= order.paymentMethod %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>



<p id="no-data" style="display:none; text-align:center; font-weight:bold;">No orders found for this period</p>

</div>

<!-- jsPDF & autoTable (if you use your PDF code) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- SheetJS for XLSX export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- JS Libraries -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>

document.addEventListener("DOMContentLoaded", () => {
  const rows = document.querySelectorAll("table tbody tr");
  const noDataMsg = document.getElementById("no-data");

  const select = document.getElementById("timePeriod");
  const filterBtn = document.getElementById("filterBtn");

  // Enable button
  select.addEventListener("change", () => {
    filterBtn.disabled = !select.value;
  });

  // -------------------------
  // WEEK / MONTH / YEAR FILTER
  // -------------------------
  filterBtn.addEventListener("click", () => {
    const period = select.value;
    if (!period) return;

    const now = new Date();
    let startDate, endDate;

    if (period === "week") {
      // Sunday to Saturday
      const day = now.getDay(); // Sun = 0
      startDate = new Date(now);
      startDate.setDate(now.getDate() - day); // Sunday
      endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6); // Saturday
    }

    if (period === "month") {
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    }

    if (period === "year") {
      startDate = new Date(now.getFullYear(), 0, 1);
      endDate = new Date(now.getFullYear(), 11, 31);
    }

    filterTable(startDate, endDate);
  });

  // -------------------------
  // DATE RANGE FILTER
  // -------------------------
  document.getElementById("date-wise-filter").addEventListener("submit", (e) => {
    e.preventDefault();

    const startDateInput = document.getElementById("startDate").value;
    const endDateInput = document.getElementById("endDate").value;

    if (!startDateInput || !endDateInput) {
      alert("Please select both FROM and TO dates");
      return;
    }

    const startDate = new Date(startDateInput);
    const endDate = new Date(endDateInput);
    endDate.setHours(23, 59, 59, 999);

    filterTable(startDate, endDate);
  });

  // -------------------------
  // MAIN FILTER FUNCTION
  // -------------------------
  function filterTable(startDate, endDate) {
    let count = 0;
    noDataMsg.style.display = "none";

    rows.forEach(row => {
      const dateStr = row.getAttribute("data-order-date");
      const orderDate = new Date(dateStr);

      if (orderDate >= startDate && orderDate <= endDate) {
        row.style.display = "";
        count++;
      } else {
        row.style.display = "none";
      }
    });

    noDataMsg.style.display = count === 0 ? "block" : "none";
  }
});

// Set max date as today (disable future dates)
const today = new Date().toISOString().split("T")[0];

document.getElementById("startDate").setAttribute("max", today);
document.getElementById("endDate").setAttribute("max", today);


document.addEventListener('DOMContentLoaded', function () {
  const TABLE_ID = 'ordersTable';
  const desiredStatus = 'Delivered'; // change if you want another status

  // 1) Filter: show only rows with orderStatus === desiredStatus
  function filterByStatus(status) {
    const table = document.getElementById(TABLE_ID);
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const rowStatus = row.getAttribute('data-order-status') || '';
      if (rowStatus.trim().toLowerCase() === status.trim().toLowerCase()) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  // Immediately filter to "Delivered"
  filterByStatus(desiredStatus);

  // Helpers to get visible table data (headers + rows)
  function getVisibleTableData() {
    const table = document.getElementById(TABLE_ID);
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
    const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
      .filter(tr => tr.style.display !== 'none');
    const rows = visibleRows.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim()));
    return { headers, rows };
  }

  // 2) CSV download
document.getElementById('download-csv').addEventListener('click', function () {
  const { headers, rows } = getVisibleTableData();
  if (rows.length === 0) {
    alert('No rows to export.');
    return;
  }

  // COMPANY INFO
  const companyName = "XEMAR";
  const companyEmail = "hello@xemart.com";

  // AUTO DETECT COLUMNS
  let amountIndex = headers.findIndex(h =>
    h.toLowerCase().includes("amount") ||
    h.toLowerCase().includes("total") ||
    h.toLowerCase().includes("price")
  );
  if (amountIndex === -1) amountIndex = headers.length - 1;

  let discountIndex = headers.findIndex(h =>
    h.toLowerCase().includes("discount")
  );
  if (discountIndex === -1) discountIndex = null;

  const cleanNum = (v) =>
    parseFloat(String(v).replace(/[^0-9.-]/g, "")) || 0;

  // TOTAL CALCULATIONS
  let totalRevenue = 0;
  let totalDiscount = 0;

  rows.forEach(r => {
    totalRevenue += cleanNum(r[amountIndex]);
    if (discountIndex !== null) totalDiscount += cleanNum(r[discountIndex]);
  });

  const totalOrders = rows.length;
  const avgOrderValue = totalRevenue / totalOrders;

  // CSV BUILDER
  const BOM = "\uFEFF";
  const escapeCell = (str) => {
    if (str == null) return "";
    str = String(str);
    if (str.includes('"')) str = str.replace(/"/g, '""');
    if (/[,"\n\r]/.test(str)) return `"${str}"`;
    return str;
  };

  const today = new Date();
  const generatedOn = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

  const csvLines = [];

  // -----------------------------
  // COMPANY DETAILS
  // -----------------------------
  csvLines.push(`${companyName} - SALES REPORT`);
  csvLines.push(`Email: ${companyEmail}`);
  csvLines.push(`Report Period: Auto Selected`);
  csvLines.push(`Generated On: ${generatedOn}`);
  csvLines.push("");

  // -----------------------------
  // SUMMARY
  // -----------------------------
  csvLines.push("SUMMARY");
  csvLines.push(`Total Orders,${totalOrders}`);
  csvLines.push(`Total Revenue,${totalRevenue.toFixed(2)}`);
  csvLines.push(`Total Discount,${totalDiscount.toFixed(2)}`);
  csvLines.push(`Avg Order Value,${avgOrderValue.toFixed(2)}`);
  csvLines.push("");

  // -----------------------------
  // ORDER DETAILS
  // -----------------------------
  csvLines.push("ORDER DETAILS");
  csvLines.push(headers.join(","));
  rows.forEach(r => csvLines.push(r.map(escapeCell).join(",")));

  const csvContent = BOM + csvLines.join("\r\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "sales_report.csv";
  a.click();
  URL.revokeObjectURL(url);
});

  // 3) XLSX (SheetJS) download - produces .xlsx file
  document.getElementById('download-xlsx').addEventListener('click', function () {
    const { headers, rows } = getVisibleTableData();
    if (rows.length === 0) {
      alert('No rows to export.');
      return;
    }

    // Build worksheet data (array of arrays)
    const aoa = [headers, ...rows];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(aoa);

    // Optional: set column widths (auto-ish)
    const colWidths = headers.map(h => ({ wch: Math.max(10, Math.ceil(h.length * 1.2)) }));
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, 'Orders');
    XLSX.writeFile(wb, 'orders_export.xlsx');
  });

  // 4) PDF download (your jsPDF + autoTable code updated to export only visible rows)
 
document.getElementById("download-pdf").addEventListener("click", function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Get table data
  const { headers, rows } = getVisibleTableData();
  if (rows.length === 0) {
    alert("No rows to export.");
    return;
  }

  // -----------------------------
  // AUTO DETECT AMOUNT COLUMN
  // -----------------------------
  let amountIndex = headers.findIndex(h =>
    h.toLowerCase().includes("amount") ||
    h.toLowerCase().includes("price") ||
    h.toLowerCase().includes("total")
  );

  // Fallback if not found ‚Üí last column
  if (amountIndex === -1) amountIndex = headers.length - 1;

  // AUTO DETECT DISCOUNT COLUMN
  let discountIndex = headers.findIndex(h =>
    h.toLowerCase().includes("discount")
  );

  if (discountIndex === -1) discountIndex = null;

  // -----------------------------
  // CALCULATE TOTAL REVENUE & DISCOUNT
  // -----------------------------
  let totalRevenue = 0;
  let totalDiscount = 0;

  rows.forEach(row => {
    // Amount
    let amt = parseFloat(String(row[amountIndex]).replace(/[^0-9.-]/g, ""));
    if (!isNaN(amt)) totalRevenue += amt;

    // Discount
    if (discountIndex !== null) {
      let disc = parseFloat(String(row[discountIndex]).replace(/[^0-9.-]/g, ""));
      if (!isNaN(disc)) totalDiscount += disc;
    }
  });

  const totalOrders = rows.length;
  const avgOrderValue = totalRevenue / totalOrders;

  // -----------------------------
  // PDF HEADER
  // -----------------------------
  doc.setFontSize(26);
  doc.text("XEMART - SALES REPORT", 14, 18);

  doc.setFontSize(11);
  doc.text("Report Period: Auto Selected", 14, 30);

  const today = new Date();
  const generatedOn = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

  const pageWidth = doc.internal.pageSize.getWidth();
  doc.text("Generated On: " + generatedOn, pageWidth - 60, 30);

  // -----------------------------
  // SUMMARY SECTION
  // -----------------------------
  doc.setFontSize(13);
  doc.setFont(undefined, "bold");
  doc.text("SUMMARY", 14, 45);
  doc.line(14, 48, pageWidth - 14, 48);

  const summaryData = [
    ["Total Orders", totalOrders],
    ["Total Revenue",   totalRevenue.toFixed(2)],
    ["Total Discount",  totalDiscount.toFixed(2)],
    ["Avg. Order Value",  avgOrderValue.toFixed(2)],
  ];

  doc.autoTable({
    body: summaryData,
    startY: 53,
    theme: "grid",
    styles: { fontSize: 10 },
    columnStyles: {
      0: { fontStyle: "bold" }
    }
  });

  // -----------------------------
  // ORDER DETAILS TITLE
  // -----------------------------
  let finalY = doc.previousAutoTable.finalY + 10;
  doc.setFontSize(13);
  doc.setFont(undefined, "bold");
  doc.text("ORDER DETAILS", 14, finalY);
  doc.line(14, finalY + 3, pageWidth - 14, finalY + 3);

  // -----------------------------
  // MAIN TABLE
  // -----------------------------
  doc.autoTable({
    head: [headers],
    body: rows,
    startY: finalY + 10,
    theme: "grid",
    headStyles: { fillColor: [0, 0, 0], textColor: 255, fontSize: 11 },
    bodyStyles: { fontSize: 10 },
  });

  doc.save("sales_report.pdf");
});




});



const dateForm = document.getElementById("date-wise-filter");
const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const tableBody = document.querySelector("tbody");

// Store original rows to show all later
const allRows = Array.from(tableBody.querySelectorAll("tr"));

dateForm.addEventListener("submit", function(e) {
  e.preventDefault();

  const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
  const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

  // Clear table
  tableBody.innerHTML = "";

  // Filter and show rows
  const filteredRows = allRows.filter(row => {
    const orderDate = new Date(row.getAttribute("data-order-date"));
    if(startDate && endDate) {
      return orderDate >= startDate && orderDate <= endDate;
    }
    return true; // If no dates selected, show all
  });

  // Append filtered rows
  filteredRows.forEach((row, index) => {
    // Update serial number
    row.cells[0].innerText = index + 1;
    tableBody.appendChild(row);
  });
});





    // Date Picker min/max
    let startDate = document.getElementById("startDate");
    let endDate = document.getElementById("endDate");

    startDate.addEventListener("change", () => endDate.setAttribute("min", startDate.value));
    endDate.addEventListener("change", () => startDate.setAttribute("max", endDate.value));

    function clearFilter() { location.reload(); }

    async function downloadPdf(report) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica", "bold");
      doc.setFontSize(22);
      doc.text("Sales Report", 80, 15);

      const salesData = report;
      doc.autoTable({
        startY: 25,
        head: [salesData[0]],
        body: salesData.slice(1),
        theme: "grid",
        headStyles: { fillColor: [0, 150, 136], textColor: 255, fontSize: 12 },
        bodyStyles: { fontSize: 10, cellPadding: 4 },
        margin: { top: 20 }
      });

      doc.save("sales_report.pdf");
    }



    const menuBtn = document.getElementById("menuBtn");
const sidebar = document.querySelector("aside");

menuBtn.onclick = () => {
  sidebar.classList.toggle("open");
}



  </script>
</body>
</html>