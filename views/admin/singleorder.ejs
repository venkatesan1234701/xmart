<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details - <%= order.orderId %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  /* ---------------------------------------------------
   GLOBAL BASE SETUP
--------------------------------------------------- */
body {
  background-color: #f9fafb;
  font-family: 'Inter', sans-serif;
}

.return-disabled {
  pointer-events: none;
  cursor: not-allowed;
  opacity: 0.5;
}

.container {
  max-width: 1100px;
}

/* ---------------------------------------------------
   CARDS
--------------------------------------------------- */
.order-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 22px;
  box-shadow: 0 3px 18px rgba(0, 0, 0, 0.06);
  margin-bottom: 25px;
  transition: transform .2s ease;
}

.order-card:hover {
  transform: translateY(-3px);
}

.order-card h5 {
  font-size: 1rem;
  color: #374151;
  font-weight: 600;
}

/* ---------------------------------------------------
   CUSTOMER & ORDER INFO TEXT
--------------------------------------------------- */
.order-card p {
  margin-bottom: 6px;
  color: #4b5563;
}

.order-card strong {
  color: #111827;
}

/* ---------------------------------------------------
   TABLE STYLES
--------------------------------------------------- */
.table {
  border-radius: 8px;
  overflow: hidden;
}

.table thead th {
  background: #1f2937 !important;
  color: #ffffff !important;
  font-size: 0.85rem;
  letter-spacing: .4px;
  padding: 12px;
}

.table td {
  padding: 14px;
  color: #374151;
  font-size: 0.9rem;
  vertical-align: middle;
}

.table tbody tr:hover {
  background-color: #f3f4f6;
}

/* Product image */
.object-cover {
  object-fit: cover;
}

.badge {
  font-size: 0.8rem;
  padding: 6px 12px;
  border-radius: 8px;
}

/* ---------------------------------------------------
   STATUS SELECT & BUTTON
--------------------------------------------------- */
.form-select {
  border-radius: 6px;
  font-size: 0.85rem;
  padding: 6px 8px;
}

.save-btn {
  background-color: #16a34a;
  color: #fff;
  padding: 8px 18px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all .2s ease;
}

.save-btn:hover {
  background-color: #15803d;
  transform: scale(1.03);
}

.save-btn:active {
  transform: scale(0.97);
}

.save-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ---------------------------------------------------
   BACK BUTTON
--------------------------------------------------- */
.btn-primary {
  font-weight: 500;
  padding: 8px 20px;
  border-radius: 8px;
}

/* ---------------------------------------------------
   GRAND TOTAL
--------------------------------------------------- */
.grand-total {
  font-size: 1.4rem;
  color: #16a34a;
  font-weight: 700;
}

/* ---------------------------------------------------
   RETURN APPROVAL BUTTON
--------------------------------------------------- */
.btn-success {
  padding: 8px 16px;
  font-size: 0.85rem;
  border-radius: 6px;
}

/* ---------------------------------------------------
   RESPONSIVE FIXES
--------------------------------------------------- */
@media (max-width: 768px) {
  .order-card {
    padding: 18px;
  }

  .table td img {
    width: 50px;
    height: 50px;
  }

  .d-flex.gap-2 {
    flex-direction: column;
    align-items: stretch !important;
  }

  .save-btn {
    width: 100%;
  }
}

</style>

<!-- 
  <style>
    body {
      background-color: #f9fafb;
      font-family: 'Inter', sans-serif;
    }
    .order-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    .badge {
      font-size: 0.85rem;
    }

.save-btn {
  background-color: #16a34a;       /* Tailwind green-600 */
  color: #ffffff;                  /* White text */
  padding: 6px 12px;               /* px-2 py-1 */
  border-radius: 0.375rem;         /* rounded */
  font-size: 0.875rem;             /* text-sm */
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.save-btn:hover {
  background-color: #15803d;      
  transform: scale(1.03);         
}

.save-btn:active {
  transform: scale(0.98);          
}

.save-btn:disabled {
  background-color: #16a34a;      
  opacity: 0.6;                   
  cursor: not-allowed;
  transform: none;
}


  </style> -->
</head>
<body class="container py-4">

   
  <div class=" mt-4">
    <a href="/admin/orders" class="btn btn-primary px-4">‚¨Ö Back to Orders</a>
  </div>

  <!-- üßæ Page Title -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">Order Details</h2>
    <p class="text-muted">Order ID: <%= order.orderId %></p>
  </div>

  <!-- üë• Customer & Order Info -->
  <div class="row g-4">
    <!-- Customer -->
    <div class="col-md-6">
      <div class="order-card">
        <h5 class="border-bottom pb-2 mb-3">üë§ Customer Details</h5>
        <p class="fw-semibold"><%= order.user.name %></p>
        <p class="text-muted mb-2"><%= order.user.email %></p>
        <p><strong>Phone:</strong> <%= order.user.phone %></p>

        <h6 class="border-bottom pb-2 mb-2 mt-3">üì¶ Shipping Address</h6>
        <p><%= order.shippingAddress?.addressLine1 || "" %></p>
        <% if (order.shippingAddress?.addressLine2) { %>
          <p><%= order.shippingAddress.addressLine2 %></p>
        <% } %>
        <p>
          <%= order.shippingAddress?.city || "" %>,
          <%= order.shippingAddress?.state || "" %> -
          <%= order.shippingAddress?.zipCode || "" %>
        </p>
        <p><%= order.shippingAddress?.country || "India" %></p>
      </div>
    </div>

    <!-- Order Info -->
    <div class="col-md-6">
      <div class="order-card">
        <h5 class="border-bottom pb-2 mb-3">üßæ Order Details</h5>
        <p><strong>Payment Method:</strong> <%= order.paymentDetails.method %></p>
        <p><strong>Payment Status:</strong> <%= order.paymentDetails.status %></p>
        <p><strong>Shipping Cost:</strong> ‚Çπ<%= order.shippingCost.toFixed(2) %></p>
        <p><strong>Expected Delivery:</strong>
          <%= order.expectedDelivery ? new Date(order.expectedDelivery).toLocaleDateString() : "N/A" %>
        </p>
      </div>
    </div>
  </div>

  <!-- üõçÔ∏è Products -->
  <!-- <div class="order-card mt-4">
    <h5 class="border-bottom pb-2 mb-3">üõí Ordered Products</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th class="text-center">Qty</th>
            <th class="text-center">Size</th>
            <th class="text-end">Total</th>
            <th class="text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          <% order.products.forEach(item => { %>
            <tr>
            <td>
  <div class="d-flex align-items-center gap-3">
    <img 
      src="<%= item.image %>" 
      alt="Product" 
      width="60" 
      height="60" 
      class="rounded border object-cover"
      onerror="this.onerror=null; this.src='/images/default-product.jpg';">
    <span><%= item.name %></span>
  </div>
</td>

              <td class="text-center"><%= item.quantity %></td>
              <td class="text-center"><%= item.size || '-' %></td>
              <td class="text-end fw-semibold">‚Çπ<%= item.totalPrice.toFixed(2) %></td>


              <td class="text-center">
  <div class="flex items-center justify-center gap-2">
<select 
  id="status-<%= order._id %>" 
  class="form-select border rounded px-2 py-1 text-sm"
  onchange="updateOrderStatus('<%= order._id %>')"
  <%= (order.orderStatus === 'Delivered' || order.orderStatus === 'Cancelled' || order.orderStatus === 'Returned') ? 'disabled' : '' %>>
  
  <% if (order.orderStatus === 'Cancelled') { %>
    <option value="Cancelled" selected>Cancelled</option>
  <% } else if (order.orderStatus === 'Returned') { %>
    <option value="Returned" selected>Returned</option>
  <% } else { %>
    <option value="Pending" <%= order.orderStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
    <option value="Processing" <%= order.orderStatus === 'Processing' ? 'selected' : '' %>>Processing</option>
    <option value="Shipped" <%= order.orderStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
    <option value="Delivered" <%= order.orderStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
  <% } %>
</select>
 <button 
  type="button" 
  class="save-btn"
  onclick="confirmAndUpdate('<%= order._id %>')"
  <%= (order.orderStatus === "Delivered" || order.orderStatus === "Cancelled") ? "disabled" : "" %>>
  Save
</button>


  </div>
</td>


            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between flex-wrap mt-4 border-top pt-3">
      <div>
        <h6>Payment Info</h6>
        <span class="badge bg-light text-dark p-2">
          <%= order.paymentDetails.method %>
        </span>
      </div>
      <div class="text-end">
        <p><strong>Sub Total:</strong> ‚Çπ<%= order.subTotal.toFixed(2) %></p>
        <p><strong>Shipping:</strong> ‚Çπ<%= order.shippingCost.toFixed(2) %></p>
        <p class="fw-bold text-success fs-5">Grand Total: ‚Çπ<%= order.grandTotal.toFixed(2) %></p>
      </div>
    </div>
  </div> -->


<div class="order-card mt-4">

  <h5 class="border-bottom pb-2 mb-3">üõí Ordered Products</h5>

  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th class="text-center">Qty</th>
          <th class="text-center">Size</th>
          <th class="text-end">Total</th>
          <th class="text-center">Item Status</th>
        </tr>
      </thead>

      <tbody>
        <% order.products.forEach(item => { %>
          <tr>

            <!-- PRODUCT -->
            <td>
              <div class="d-flex align-items-center gap-3">
                <img 
                  src="<%= item.image %>" 
                  width="60" height="60"
                  class="rounded border object-cover"
                  onerror="this.onerror=null; this.src='/images/default-product.jpg';">
                <span><%= item.name %></span>
              </div>
            </td>

            <!-- QTY -->
            <td class="text-center"><%= item.quantity %></td>

            <!-- SIZE -->
            <td class="text-center"><%= item.size || '-' %></td>

            <!-- TOTAL -->
            <td class="text-end fw-semibold">‚Çπ<%= item.totalPrice.toFixed(2) %></td>

            <!-- ITEM STATUS -->
            <td class="text-center">
              <span class="badge bg-light text-dark px-3 py-2">
                <% if (item.itemStatus) { %>
                  <%= item.itemStatus %>
                <% } else if (item.status) { %>
                  <%= item.status %>
                <% } else if (item.productStatus) { %>
                  <%= item.productStatus %>
                <% } else if (item.orderItemStatus) { %>
                  <%= item.orderItemStatus %>
                <% } else { %>
                  No Status
                <% } %>
              </span>
            </td>

          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- üü¶ Bottom Section Alignment FIXED -->
  <div class="d-flex justify-content-between align-items-start flex-wrap mt-4 border-top pt-3">

    <!-- LEFT SIDE -->
    <div>
      <h6>Payment Info</h6>
      <span class="badge bg-light text-dark p-2">
        <%= order.paymentDetails.method %>
      </span>
    </div>

    <!-- RIGHT SIDE STATUS + BUTTON -->
    <div class="d-flex align-items-center gap-2">

     

<% 
  const hasReturningItems = order.products && order.products.some(item => 
    item.itemStatus && item.itemStatus.toString().toLowerCase().trim() === 'returning'
  );
  const isOrderReturning = order.orderStatus && order.orderStatus.toString().toLowerCase().trim() === 'returning';
  const showApproveBtn = hasReturningItems || isOrderReturning;
  const returnCount = order.products.filter(item => item.itemStatus?.toString().toLowerCase().trim() === 'returning').length;
%>

<% if (showApproveBtn) { %>
 <button
  class="btn btn-sm btn-success w-100 px-3 py-2 text-start border rounded
         <%= returnCount === 0 ? 'return-disabled' : '' %>"
  onclick="processReturns('<%= order._id %>')"
  title="<%= returnCount === 0 ? 'No returning items' : returnCount + ' returning items' %>">

  <i class="fas fa-check-circle me-2"></i>
  Approve Returns (<%= returnCount %>)
</button>

<% } else { %>
  <select id="status-<%= order._id %>" class="form-select border rounded px-3 py-2 text-sm"
          onchange="updateOrderStatus('<%= order._id %>')"
          <%= (order.orderStatus === 'Delivered' || order.orderStatus === 'Cancelled' || order.orderStatus === 'Returned') ? 'disabled' : '' %>>
    <% if (order.orderStatus === 'Cancelled') { %>
      <option value="Cancelled" selected>Cancelled</option>
    <% } else if (order.orderStatus === 'Returned') { %>
      <option value="Returned" selected>Returned</option>
    <% } else { %>
      <option value="Pending" <%= order.orderStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
      <option value="Processing" <%= order.orderStatus === 'Processing' ? 'selected' : '' %>>Processing</option>
      <option value="Shipped" <%= order.orderStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
      <option value="Delivered" <%= order.orderStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
    <% } %>
  </select>
<% } %>





      <button 
        type="button" 
        class="save-btn px-3 py-2"
        onclick="confirmAndUpdate('<%= order._id %>')"
        <%= (order.orderStatus === 'Delivered' || order.orderStatus === 'Cancelled') ? 'disabled' : '' %>>
        Save
      </button>

    </div>
  </div>

  <!-- GRAND TOTAL BELOW RIGHT -->
   


  <%
  let netTotal = 0;

  order.products.forEach(item => {
    if (item.itemStatus !== "Cancelled" && item.itemStatus !== "Returned") {
      netTotal += item.totalPrice;
    }
  });
%>
<!-- 
  <div class="d-flex justify-content-end mt-2">
    <p class="fw-bold text-success fs-5">
      Grand Total: ‚Çπ<%= order.grandTotal.toFixed(2) %>
    </p>
  </div> -->


  <div class="d-flex justify-content-end mt-2">
  <p class="fw-bold text-success fs-5">
    Grand Total: ‚Çπ<%= netTotal.toFixed(2) %>
  </p>
</div>


</div>


</div>






  <!-- üõçÔ∏è Products -->


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- 

<script>

  async function updateOrderStatus(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;

    try {
      const res = await fetch(`/admin/update-order-status/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderStatus: newStatus })
      });

      const data = await res.json();

      if (data.success) {
        alert('‚úÖ Order status updated successfully!');
        location.reload(); // Refresh page to show updated status
      } else {
        alert('‚ùå Failed to update order status: ' + data.message);
      }
    } catch (err) {
      console.error('‚ùå Error updating order status:', err);
    
    }
  }


async function confirmAndUpdate(orderId) {
  const selectEl = document.getElementById(`status-${orderId}`);
  const newStatus = selectEl.value;

  // ‚ùóIf already delivered, block further changes
  if (selectEl.disabled) {
    Swal.fire({
      icon: "info",
      title: "Locked",
      text: "This order is already delivered and cannot be modified.",
    });
    return;
  }

  const result = await Swal.fire({
    title: 'Confirm Update',
    text: `Change order status to "${newStatus}"?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#16a34a',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, Update it!',
  });

  if (result.isConfirmed) {
    try {
      const res = await fetch(`/admin/updateOrderStatus/${orderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      const data = await res.json();

      if (res.ok && data.success) {
        await Swal.fire({
          icon: 'success',
          title: 'Updated!',
          text: 'Order status updated successfully.',
          timer: 1500,
          showConfirmButton: false,
        });

        // ‚úÖ Disable the dropdown + button if delivered
        if (newStatus === "Delivered") {
          selectEl.disabled = true;
          document.querySelector(`button[onclick="confirmAndUpdate('${orderId}')"]`).disabled = true;
        }

        // Optional: refresh page if needed
        // window.location.reload();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Failed!',
          text: data.message || 'Update failed.',
        });
      }
    } catch (err) {
      console.error('‚ùå Fetch error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Server error. Please try again later.',
      });
    }
  }
}
</script>
   -->

   
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

   async function updateOrderStatus(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;

    try {
      const res = await fetch(`/admin/update-order-status/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderStatus: newStatus })
      });

      const data = await res.json();

      if (data.success) {
        alert(' Order status updated successfully!');
        location.reload(); // Refresh page to show updated status
      } else {
        alert(' Failed to update order status: ' + data.message);
      }
    } catch (err) {
      console.error(' Error updating order status:', err);
      // alert(' Something went wrong while updating order status');
    }
  }


async function confirmAndUpdate(orderId) {
  const selectEl = document.getElementById(`status-${orderId}`);
  const newStatus = selectEl.value;

  // If already delivered, block further changes
  if (selectEl.disabled) {
    Swal.fire({
      icon: "info",
      title: "Locked",
      text: "This order is already delivered and cannot be modified.",
    });
    return;
  }

  const result = await Swal.fire({
    title: 'Confirm Update',
    text: `Change order status to "${newStatus}"?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#16a34a',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, Update it!',
  });

  if (result.isConfirmed) {
    try {
      const res = await fetch(`/admin/updateOrderStatus/${orderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      const data = await res.json();

      if (res.ok && data.success) {
        await Swal.fire({
          icon: 'success',
          title: 'Updated!',
          text: 'Order status updated successfully.',
          timer: 1500,
          showConfirmButton: false,
        });

        // Disable the dropdown + button if delivered
        if (newStatus === "Delivered") {
          selectEl.disabled = true;
          document.querySelector(`button[onclick="confirmAndUpdate('${orderId}')"]`).disabled = true;
        }

        // Optional: refresh page if needed
        // window.location.reload();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Failed!',
          text: data.message || 'Update failed.',
        });
      }
    } catch (err) {
      console.error(' Fetch error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Server error. Please try again later.',
      });
    }
  }
}

async function processReturns(orderId) {
  console.log(" APPROVE CLICKED:", orderId);
  
  const confirm = await Swal.fire({
    title: "Approve all returns?",
    text: "This will process all Returning items and add refund to wallet",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Yes, approve all",
    confirmButtonColor: "#28a745"
  });
  
  if (!confirm.isConfirmed) return;

  try {
    //  FIXED URL - /admin/ prefix add pannunga!
    const url = `/admin/orders/${orderId}/approve-returns`;
    console.log(" FETCHING:", url);
    
    const res = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": "application/json" }
    });

    console.log(" STATUS:", res.status);
    const data = await res.json();
    
    if (res.ok) {
      await Swal.fire(" Approved!", data.message, "success");
      location.reload();
    } else {
      Swal.fire(" Error", data.message || "Failed", "error");
    }
  } catch (err) {
    console.error("ERROR:", err);
    Swal.fire(" Error", "Try again", "error");
  }
}


</script>









</body>
</html>