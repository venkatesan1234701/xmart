<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coupon Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/theme.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* ----------------------------------------
   GLOBAL PAGE STYLING
-----------------------------------------*/
body {
  font-family: "Inter", sans-serif;
  background: #f8fafc;
  margin: 0;
  color: #1e293b;
}

@media (max-width: 640px) {
  aside {
    transform: translateX(-100%);
    transition: 0.3s;
  }

  aside.open {
    transform: translateX(0);
  }

  main {
    margin-left: 0 !important;
    width: 100% !important;
  }
}

h2 {
  font-weight: 700;
  color: #0f172a;
}

/* ----------------------------------------
   NAVBAR
-----------------------------------------*/
.navbar {
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  padding: 12px 18px;
}

.nav-link {
  font-weight: 500;
  transition: 0.25s ease;
}

.nav-link:hover {
  color: #16a34a !important;
}

/* ----------------------------------------
   SEARCH BAR
-----------------------------------------*/
#coupon-search {
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  padding: 7px 12px;
  transition: 0.25s ease;
}

#coupon-search:focus {
  border-color: #22c55e;
  box-shadow: 0 0 0 3px rgba(34,197,94,0.25);
}

/* Search Button */
button[type="submit"] {
  border-radius: 8px;
}

/* ----------------------------------------
   ADD COUPON BUTTON
-----------------------------------------*/
#openModalBtn {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  box-shadow: 0 2px 6px rgba(34,197,94,0.3);
  padding: 8px 18px;
  border-radius: 10px;
  transition: all 0.3s ease;
}

#openModalBtn:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #15803d, #16a34a);
}

/* ----------------------------------------
   TABLE DESIGN
-----------------------------------------*/
.table-responsive {
  background: #ffffff;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0px 4px 14px rgba(0,0,0,0.06);
}

table thead {
  background: #eef2f7;
}

table thead th {
  font-weight: 600;
  font-size: 14px;
  padding: 12px;
}

table tbody td {
  font-size: 14px;
  padding: 10px;
}

table tbody tr:hover {
  background: #f8fafc;
  transition: 0.2s ease;
}



/* ----------------------------------------
   EDIT + DELETE BUTTONS
-----------------------------------------*/
.btn-edit {
  color: #0d6efd;
  border: 1px solid #0d6efd;
  border-radius: 6px;
  padding: 4px 12px;
  transition: all .3s ease;
}

.btn-edit:hover {
  background: #0d6efd;
  color: white;
  transform: translateY(-2px);
}

/* ==================================================
   COUPON PAGE ‚Äì RESPONSIVE CSS ONLY
================================================== */

/* ---------- SIDEBAR (MOBILE) ---------- */
@media (max-width: 768px) {
  aside {
    transform: translateX(-100%);
    transition: 0.3s ease;
    z-index: 50;
  }

  aside.open {
    transform: translateX(0);
  }

  main {
    margin-left: 0 !important;
    width: 100% !important;
  }

  #menuBtn {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 60;
  }
}

/* ---------- TABLE SCROLL ---------- */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* ---------- TABLE BASE ---------- */
.table-responsive table {
  width: 100%;
  min-width: 1100px;
  border-collapse: collapse;
}

/* ---------- HEAD / CELL ---------- */
.table-responsive th,
.table-responsive td {
  white-space: nowrap;
  vertical-align: middle;
  text-align: center;
}

/* ---------- COUPON CODE COLUMN (ALLOW WRAP) ---------- */
.table-responsive td:nth-child(2) {
  white-space: normal;
  min-width: 160px;
  word-break: break-word;
}

/* ---------- DATE / AMOUNT ---------- */
.table-responsive td:nth-child(4),
.table-responsive td:nth-child(5),
.table-responsive td:nth-child(6),
.table-responsive td:nth-child(7) {
  min-width: 120px;
}

/* ---------- STATUS ---------- */
.table-responsive td:nth-child(8) {
  min-width: 120px;
}

/* ---------- EDIT / DELETE ---------- */
.table-responsive td:nth-last-child(1),
.table-responsive td:nth-last-child(2) {
  min-width: 110px;
}

.table-responsive td button {
  display: inline-block;
  white-space: nowrap;
}

/* ---------- MOBILE FONT ---------- */
@media (max-width: 576px) {
  .table-responsive th,
  .table-responsive td {
    font-size: 13px;
    padding: 8px;
  }

  .table-responsive table {
    min-width: 1000px;
  }
}

:root {
  --primary: #16a34a;
  --primary-dark: #059669;
  --bg-main: #f5f7fa;
  --sidebar-bg: #ffffff;
  --danger: #dc2626;
}


.btn-delete {
  color: #dc2626;
  border: 1px solid #dc2626;
  border-radius: 6px;
  padding: 4px 12px;
  transition: all .3s ease;
}

.btn-delete:hover {
  background: #dc2626;
  color: white;
  transform: translateY(-2px);
}

/* ----------------------------------------
   STATUS BADGES
-----------------------------------------*/
.badge.bg-success {
  background: #16a34a !important;
}

.badge.bg-danger {
  background: #dc2626 !important;
}

.badge.bg-warning {
  background: #fbbf24 !important;
  color: #1f2937 !important;
}

/* ----------------------------------------
   MODAL DESIGN
-----------------------------------------*/
.modal-content {
  border-radius: 14px !important;
  padding: 16px;
  border: none;
  animation: fadeIn .3s ease;
}

.modal-title {
  font-weight: 700;
  color: #0f172a;
}

.modal-body input,
.modal-body select {
  border-radius: 10px !important;
  border: 1px solid #cbd5e1 !important;
  padding: 10px;
  transition: .2s ease;
}

.modal-body input:focus,
.modal-body select:focus {
  border-color: #22c55e !important;
  box-shadow: 0 0 0 3px rgba(34,197,94,.25);
}

/* Modal buttons */
.modal-body .btn-success {
  background: #16a34a !important;
  border-radius: 8px;
  padding: 8px 14px;
}

.modal-body .btn-secondary {
  border-radius: 8px;
  padding: 8px 14px;
}

/* ----------------------------------------
   PAGINATION
-----------------------------------------*/
.pagination .page-link {
  border-radius: 8px;
  padding: 6px 12px;
  border: 1px solid #cbd5e1;
  transition: .2s ease;
}

.pagination .page-link:hover {
  background: #e2e8f0;
}

.pagination .active .page-link {
  background: #16a34a !important;
  border-color: #16a34a !important;
  color: white !important;
}

/* ----------------------------------------
   ANIMATIONS
-----------------------------------------*/
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0px); }
}

</style>


  <!-- <style>
     .btn-success {
    background: linear-gradient(135deg, #16a34a, #22c55e); /* Soft green gradient */
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    padding: 8px 20px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(22, 163, 74, 0.3);
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #15803d, #16a34a); /* Darker on hover */
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(22, 163, 74, 0.4);
  }

  .btn-success:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3);
  }

  .btn-success:focus {
    outline: none;
    box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.4); /* Subtle focus ring */
  }
     .btn-custom {
    font-weight: 500;
    padding: 5px 12px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  /* ‚úèÔ∏è Edit Button */
  .btn-edit {
    color: #0d6efd;
    border: 1px solid #0d6efd;
    background-color: white;
  }

  .btn-edit:hover {
    background-color: #0d6efd;
    color: white;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
    transform: translateY(-1px);
  }

  .btn-edit:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(13, 110, 253, 0.2);
  }

  /* üóëÔ∏è Delete Button */
  .btn-delete {
    color: #dc3545;
    border: 1px solid #dc3545;
    background-color: white;
  }

  .btn-delete:hover {
    background-color: #dc3545;
    color: white;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    transform: translateY(-1px);
  }

  .btn-delete:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(220, 53, 69, 0.2);
  }
  #openModalBtn {
    background: linear-gradient(135deg, #16a34a, #22c55e);
    color: white;
    font-weight: 600;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(22, 163, 74, 0.3);
  }

  #openModalBtn:hover {
    background: linear-gradient(135deg, #15803d, #16a34a);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(22, 163, 74, 0.4);
  }

  #openModalBtn:active {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(22, 163, 74, 0.3);
  }
</style> -->

</head>

<body class="bg-light">

  <!-- Navbar -->


  
<button id="menuBtn"
  class="md:hidden px-3 py-2 bg-green-600 text-white rounded">
  ‚ò∞
</button>


        <aside class="fixed top-0 left-0 h-screen w-64 bg-white shadow-lg z-40">
  
  <!-- Logo -->
  <div class="flex items-center justify-center h-16 border-b">
    <img src="../assets/images/logo/Xe mart.png" class="h-10" />
  </div>

  <!-- Menu -->
  <ul class="flex flex-col gap-2 p-4">

    <li>
      <a href="/admin/dashboard"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üè† <span>Dashboard</span>
      </a>
    </li>

    <li>
      <a href="/admin/products"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üõí <span>Products</span>
      </a>
    </li>

    <li>
      <a href="/admin/categories"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üìÇ <span>Categories</span>
      </a>
    </li>

    <li>
      <a href="/admin/customers"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üë• <span>Customers</span>
      </a>
    </li>

    <li>
      <a href="/admin/orders"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üì¶ <span>Orders</span>
      </a>
    </li>

    <li>
      <a href="/admin/coupons"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üéüÔ∏è <span>Coupons</span>
      </a>
    </li>

    <li>
      <a href="/admin/product-offer"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üí∏ <span>Product Offer</span>
      </a>
    </li>

    <li>
      <a href="/admin/category-offer"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üè∑Ô∏è <span>Category Offer</span>
      </a>
    </li>

    <li>
      <a href="/admin/sales-report"
         class="flex items-center gap-3 p-2 rounded hover:bg-green-100 text-gray-700">
        üìä <span>Sales Report</span>
      </a>
    </li>

    <li class="mt-6">
      <a href="/admin/logout"
         class="flex items-center gap-3 p-2 rounded text-red-600 hover:bg-red-100">
        üö™ <span>Logout</span>
      </a>
    </li>

  </ul>
</aside>

	<div class="main-wrapper">
<main class="pt-6 pt-20 min-h-screen overflow-y-auto"
  style="margin-left:14rem; width:calc(100% - 16rem);">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-semibold text-dark">Coupons</h2>
    <button class="btn btn-success" id="openModalBtn">+ Add Coupon</button>
  </div>


<form action="" method="get" class="flex items-center gap-2 mb-3">
  <input
    name="search"
    id="coupon-search"
    value="<%= search || '' %>"
    type="search"
    placeholder="Search Coupon or Discount..."
    autocomplete="off"
    class="border border-gray-300 text-gray-900 rounded-md focus:ring-green-600 focus:ring-1 block p-1.5 px-2 w-1/4 text-sm"
  />
  <button
    type="submit"
    class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md flex items-center justify-center"
  >
    üîç Search
  </button>
</form>



  <div class="table-responsive bg-white shadow-sm rounded p-3">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>S.No</th>
          <th>Coupon Code</th>
          <th>Discount %</th>
          <th>Start</th>
          <th>Expiry</th>
          <th>Min Purchase</th>
          <th>Max Discount</th>
          <th>Status</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <% if (coupons.length === 0) { %>
          <tr><td colspan="10" class="text-secondary py-4">No Coupons Found</td></tr>
        <% } else { %>
          <% coupons.forEach((c, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><%= c.couponCode %></td>
              <td><%= c.discountPercentage %>%</td>
              <td><%= c.couponStartDate?.toISOString().split('T')[0] || '-' %></td>
              <td><%= c.couponExpiryDate?.toISOString().split('T')[0] || '-' %></td>
              <td>‚Çπ<%= c.minimumPurchase %></td>
              <td>‚Çπ<%= c.maximumDiscount %></td>
              <td>
                <span class="badge 
                  <% if(c.currentStatus==='active'){ %> bg-success <% } 
                  else if(c.currentStatus==='expired'){ %> bg-danger <% } 
                  else { %> bg-warning text-dark <% } %>">
                  <%= c.currentStatus %>
                </span>
              </td>
              <td><button class="btn btn-link text-primary" onclick="openEditModal('<%= c._id %>')">Edit</button></td>
              <td><button class="btn btn-link text-danger" onclick="deleteCoupon('<%= c._id %>')">Delete</button></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</main>
  </div>
  <!-- Coupon Management Content -->



<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="couponModalLabel">Add New Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="couponForm" class="row g-3">
          <div class="col-12">
            <input id="couponCode" type="text" class="form-control" placeholder="Coupon Code">
          </div>
          <div class="col-12">
            <!-- <input id="discountPercentage" type="number" class="form-control" placeholder="Discount %" min="1" max="100">
              -->
            <input id="discountPercentage" 
       type="number" 
       class="form-control" 
       placeholder="Discount %" 
       min="1" 
       max="100">

          </div>
          <div class="col-12">
            <input id="minimumPurchase" type="number" class="form-control" placeholder="Minimum Purchase (‚Çπ)">
          </div>
          <div class="col-12">
            <input id="maximumDiscount" type="number" class="form-control" placeholder="Maximum Discount (‚Çπ)">
          </div>
          <div class="col-12">
            <label class="form-label">Coupon Start Date</label>
            <input id="couponStartDate" type="date" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Coupon Expiry Date</label>
            <input id="couponExpiryDate" type="date" class="form-control">
          </div>
          <div class="col-12">
            <select id="currentStatus" class="form-select">
              <option value="active">Active</option>
              <option value="expired">Expired</option>
              <option value="upcoming">Upcoming</option>
              <option value="Special">Special</option>
            </select>
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<nav aria-label="Page navigation example">
  <ul class="pagination justify-content-center mt-3">
    <% for(let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="?search=<%= search %>&page=<%= i %>"><%= i %></a>
      </li>
    <% } %>
  </ul>
</nav>

  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 
<script>
  const modalEl = document.getElementById("couponModal");
  const couponModal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("couponForm");

  const startInput = document.getElementById("couponStartDate");
  const expiryInput = document.getElementById("couponExpiryDate");

  const today = new Date().toISOString().split("T")[0];
  startInput.setAttribute("min", today);
  expiryInput.setAttribute("min", today);

  startInput.addEventListener("change", function () {
    expiryInput.setAttribute("min", this.value);
  });

  let editMode = false;
  let editingId = null;

  document.getElementById("openModalBtn").onclick = () => {
    editMode = false;
    editingId = null;
    form.reset();
    document.getElementById("couponModalLabel").innerText = "Add New Coupon";
    couponModal.show();
  };

  async function openEditModal(id) {
    try {
      const res = await fetch(`/admin/coupons/json/${id}`);
      if (!res.ok) throw new Error("Failed to fetch");
      const coupon = await res.json();

      editMode = true;
      editingId = id;

      document.getElementById("couponModalLabel").innerText = "Edit Coupon";
      document.getElementById("couponCode").value = coupon.couponCode || "";
      document.getElementById("discountPercentage").value = coupon.discountPercentage || "";
      document.getElementById("minimumPurchase").value = coupon.minimumPurchase || "";
      document.getElementById("maximumDiscount").value = coupon.maximumDiscount || "";
      document.getElementById("couponStartDate").value = coupon.couponStartDate ? new Date(coupon.couponStartDate).toISOString().split("T")[0] : "";
      document.getElementById("couponExpiryDate").value = coupon.couponExpiryDate ? new Date(coupon.couponExpiryDate).toISOString().split("T")[0] : "";
      document.getElementById("currentStatus").value = coupon.currentStatus || "active";

      couponModal.show();
    } catch (err) {
      Swal.fire("Error", "Failed to load coupon data", "error");
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const startDate = startInput.value;
    const expiryDate = expiryInput.value;

    if (!startDate || !expiryDate) {
      return Swal.fire("Validation Error", "Please select both start and expiry dates", "warning");
    }

    if (expiryDate < startDate) {
      return Swal.fire("Validation Error", "Expiry date cannot be before start date", "warning");
    }

    const data = {
      couponCode: document.getElementById("couponCode").value.trim(),
      discountPercentage: document.getElementById("discountPercentage").value.trim(),
      minimumPurchase: document.getElementById("minimumPurchase").value.trim(),
      maximumDiscount: document.getElementById("maximumDiscount").value.trim(),
      couponStartDate: startDate,
      couponExpiryDate: expiryDate,
      currentStatus: document.getElementById("currentStatus").value,
    }

    // ====================
// COUPON CODE
// ====================
if (!data.couponCode) {
  return Swal.fire("Validation Error", "Coupon Code cannot be empty", "warning");
}

// Max 13 characters
if (data.couponCode.length > 13) {
  return Swal.fire(
    "Validation Error",
    "Coupon Code cannot exceed 13 characters",
    "warning"
  );
}



// ====================
// DISCOUNT PERCENTAGE
// ====================
if (!data.discountPercentage) {
  return Swal.fire("Validation Error", "Discount % is required", "warning");
}

// Must be a number
if (isNaN(data.discountPercentage)) {
  return Swal.fire("Validation Error", "Discount must be a valid number", "warning");
}

// Only **2 digits allowed** (0‚Äì99)
if (data.discountPercentage.toString().length > 2) {
  return Swal.fire(
    "Validation Error",
    "Discount percentage cannot exceed 2 digits",
    "warning"
  );
}

// Must be between 1 and 100
if (data.discountPercentage < 1 || data.discountPercentage > 100) {
  return Swal.fire("Validation Error", "Discount must be between 1% and 100%", "warning");
}



// ====================
// MINIMUM PURCHASE
// ====================
if (!data.minimumPurchase) {
  return Swal.fire("Validation Error", "Minimum Purchase is required", "warning");
}

if (isNaN(data.minimumPurchase) || data.minimumPurchase < 0) {
  return Swal.fire("Validation Error", "Minimum Purchase must be a valid number", "warning");
}

// Max **7 digits** allowed
if (data.minimumPurchase.toString().length > 7) {
  return Swal.fire(
    "Validation Error",
    "Minimum Purchase cannot exceed 7 digits",
    "warning"
  );
}



// ====================
// MAXIMUM DISCOUNT
// ====================
if (!data.maximumDiscount) {
  return Swal.fire("Validation Error", "Maximum Discount is required", "warning");
}

if (isNaN(data.maximumDiscount) || data.maximumDiscount < 0) {
  return Swal.fire("Validation Error", "Maximum Discount must be a valid number", "warning");
}

// Max **6 digits** allowed
if (data.maximumDiscount.toString().length > 6) {
  return Swal.fire(
    "Validation Error",
    "Maximum Discount cannot exceed 6 digits",
    "warning"
  );
}

  

    const url = editMode ? `/admin/coupons/edit/${editingId}` : `/admin/coupons/add`;
    const method = editMode ? "PUT" : "POST";

    try {
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

  if (res.ok) {
  Swal.fire("Success", result.message || "Coupon saved!", "success")
    .then(() => location.reload());
} else {
  Swal.fire("Error", result.message || result.error || "Something went wrong", "error");
}

    } catch (err) {
      Swal.fire("Error", "Server request failed!", "error");
    }
  });

  async function deleteCoupon(id) {
    const confirmDelete = await Swal.fire({
      title: "Are you sure?",
      text: "This coupon will be deleted permanently.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it!"
    });

    if (confirmDelete.isConfirmed) {
      const res = await fetch(`/admin/coupons/delete/${id}`, { method: "DELETE" });
      const result = await res.json();

      if (result.message) {
        Swal.fire("Deleted!", result.message, "success").then(() => location.reload());
      } else {
        Swal.fire("Error!", result.error || "Unable to delete", "error");
      }
    }
  }


  const menuBtn = document.getElementById("menuBtn");
const sidebar = document.querySelector("aside");

menuBtn.onclick = () => {
  sidebar.classList.toggle("open");
};

</script>



</body>
</html>
