<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/styles/styles.css">
    <link rel="stylesheet" href="/styles/csscommon.css">
    <link rel="stylesheet" href="/styles/validationCommon.css">
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  /* Page background */
body {
  background-color: #f8f9fa;
}

/* Header logo spacing */
.validationHeader {
  background: #fff;
  border-bottom: 1px solid #e5e5e5;
}

.headerLogo img {
  height: 40px;
}

/* Center the form */
#changePasswordForm {
  max-width: 420px;
  margin: 80px auto;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
}

/* Labels */
#changePasswordForm .form-label {
  font-weight: 500;
  color: #333;
}

/* Input fields */
#changePasswordForm .form-control {
  border-radius: 8px;
  padding: 10px 12px;
}

#changePasswordForm .form-control:focus {
  border-color: #198754;
  box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

/* Eye button */
#changePasswordForm .btn-outline-secondary {
  border-radius: 8px;
}

/* Reset button */
#changePasswordForm .btn-success {
  width: 100% !important;
  padding: 10px;
  border-radius: 8px;
  font-weight: 500;
}

/* Remove inline widths effect */
#changePasswordForm .mb-3 {
  width: 100% !important;
}

/* Loading screen */
#loading-screen {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  font-size: 18px;
  z-index: 9999;
  text-align: center;
}

#loading-screen::after {
  content: "Updating password, please wait...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

</style>
</head>
<body>

    <div class="validationHeader row contain-width">
        <div class="headerLogo col-lg-6 col-2 pt-3 ">
            <img src="/images/freshKartLogo/freshcart-logo.png" alt="">
        </div>       
    </div>
    <div id="loading-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; font-size: 24px; text-align: center; line-height: 100vh;">
      Updating password, please wait...
    </div>
<form id="changePasswordForm" action="/reset-password" method="POST" class="p-4">
  <!-- hidden email -->
  <input type="hidden" id="emailField" name="email" value="<%= email %>" autocomplete="off">

  <!-- new password -->
  <div class="mb-3" style="width: 30%;">
    <label for="newPassword" class="form-label">New Password</label>
    <div class="input-group">
      <input type="password" name="password" id="newPassword" class="form-control" autocomplete="off" >
      <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword')">üëÅ</button>
    </div>
  </div>

  <!-- confirm password -->
  <div class="mb-3" style="width: 30%;">
    <label for="confirmPassword" class="form-label">Confirm Password</label>
    <div class="input-group">
      <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" autocomplete="off" >
      <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">üëÅ</button>
    </div>
  </div>

  <!-- button -->
  <div>
    <button type="submit" class="btn btn-success" style="width:10%;">Reset Password</button>
  </div>
</form>

<!-- optional loading-screen element -->
<div id="loading-screen" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div>Loading...</div>
</div>
<!-- Loading screen (hide initially) -->
<div id="loading-screen" style="display:none;">‚è≥ Changing password...</div>


    <%-include('../partials/footer')%>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/change-password.js"></script>


    <script>
  const form = document.getElementById("changePasswordForm");
  const newPassword = document.getElementById("newPassword");
  const confirmPassword = document.getElementById("confirmPassword");
  const loadingScreen = document.getElementById("loading-screen");
  const emailField = document.getElementById("emailField");

function validatePassword(password) {
  const regex =
    /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@#$%!^&*])[A-Za-z\d@#$%!^&*]{8,}$/;
  return regex.test(password);
}

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const pwd = newPassword.value.trim();
    const cpwd = confirmPassword.value.trim();
    const email = emailField.value && emailField.value.trim();

    if (!pwd) {
      Swal.fire({ icon: "warning", title: "Enter Password", text: "Please enter a new password!" });
      return false;
    }

    if (!cpwd) {
      Swal.fire({ icon: "warning", title: "Confirm Password", text: "Please re-enter the confirm password!" });
      return false;
    }

    if (!validatePassword(pwd)) {
      Swal.fire({
        icon: "error",
        title: "Weak Password",
        text: "Password must be at least 8 characters long and include uppercase, lowercase, number & special character."
      });
      return false;
    }

    if (pwd !== cpwd) {
      Swal.fire({
        icon: "error",
        title: "Password Mismatch",
        text: "New Password and Confirm Password do not match!"
      });
      return false;
    }

    // --- NEW: ask server whether new password equals old password ---
    try {
      loadingScreen.style.display = "flex";

      const res = await fetch('/api/check-password-match', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, newPassword: pwd })
      });

      const data = await res.json();
      loadingScreen.style.display = "none";

      if (!res.ok) {
        // show server error message (if any)
        const msg = data && data.error ? data.error : 'Server error';
        Swal.fire({ icon: 'error', title: 'Error', text: msg });
        return false;
      }

      // data.match === true means newPassword === old password (not allowed)
      if (data.match === true) {
        Swal.fire({
          icon: 'error',
          title: 'Password Same As Old',
          text: 'New password must NOT be same as your current password. Use a different password.'
        });
        return false;
      }

      // If here, not match => proceed to submit the form normally
      Swal.fire({
        icon: "success",
        title: "Password Changed",
        text: "Your password will be changed now."
      }).then(() => {
        // show loading and submit
        loadingScreen.style.display = "flex";
        form.submit();
      });
    } catch (err) {
      loadingScreen.style.display = "none";
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Network Error', text: 'Unable to verify password. Try again.' });
      return false;
    }
  });

  function togglePassword(id) {
    const field = document.getElementById(id);
    field.type = field.type === "password" ? "text" : "password";
  }


//   Swal.fire({
//   icon: "info",
//   title: "Google Account",
//   text: "This account was created using Google. Please sign in with Google.",
// }).then(() => {
//   window.location.href = "/signin";
// });

</script>

</body>
</html>