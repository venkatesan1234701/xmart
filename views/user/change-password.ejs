<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Change Password</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
<!-- <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- Navbar -->
  <div class="border-b shadow-sm">
    <nav class="container py-3 flex items-center">
      <a href="/" class="text-xl font-semibold">
        <img src="../assets/images/logo/Xe mart.png" alt="Logo" class="h-10 inline-block">
      </a>
    </nav>
  </div>

  <!-- Section -->
 <section class="my-12">
  <div class="container mx-auto flex justify-center">

    <div class="w-full md:w-1/2 lg:w-1/3 bg-white shadow-md rounded-xl p-8 flex flex-col gap-6">

      <div class="text-center">
        <h1 class="text-2xl font-semibold">Change Password</h1>
        <p class="text-gray-600 mt-1">Update your account password securely.</p>
      </div>

      <!-- FORM -->
      <form id="changePasswordForm" class="flex flex-col gap-5">

        <!-- Current Password -->
        <div class="flex flex-col gap-1">
          <label class="text-gray-700">Current Password</label>

          <div class="relative">
            <input 
              type="password"
              id="currentPassword"
              class="border border-gray-300 p-3 rounded-lg w-full
                     focus:shadow-[0_0_0_.25rem_rgba(10,173,10,.25)]
                     focus:border-green-600 focus:ring-green-600 focus:ring-0"
              placeholder="Enter current password"
              required
            />

            <button type="button"
              onclick="togglePassword('currentPassword', this)"
              class="absolute right-3 top-3 text-gray-500 text-xl">
              üëÅÔ∏è
            </button>
          </div>

          <p id="currentError" class="text-red-600 text-sm hidden">Enter current password</p>
        </div>

        <!-- New Password -->
        <div class="flex flex-col gap-1">
          <label class="text-gray-700">New Password</label>

          <div class="relative">
            <input 
              type="password"
              id="newPassword"
              class="border border-gray-300 p-3 rounded-lg w-full
                     focus:shadow-[0_0_0_.25rem_rgba(10,173,10,.25)]
                     focus:border-green-600 focus:ring-green-600 focus:ring-0"
              placeholder="Enter new password"
              required
            />

            <button type="button"
              onclick="togglePassword('newPassword', this)"
              class="absolute right-3 top-3 text-gray-500 text-xl">
              üëÅÔ∏è
            </button>
          </div>

          <p id="newError" class="text-red-600 text-sm hidden">Password must be minimum 8 characters</p>
        </div>

        <!-- Confirm Password -->
        <div class="flex flex-col gap-1">
          <label class="text-gray-700">Confirm New Password</label>

          <div class="relative">
            <input 
              type="password"
              id="confirmPassword"
              class="border border-gray-300 p-3 rounded-lg w-full
                     focus:shadow-[0_0_0_.25rem_rgba(10,173,10,.25)]
                     focus:border-green-600 focus:ring-green-600 focus:ring-0"
              placeholder="Confirm new password"
              required
            />

            <button type="button"
              onclick="togglePassword('confirmPassword', this)"
              class="absolute right-3 top-3 text-gray-500 text-xl">
              üëÅÔ∏è
            </button>
          </div>

          <p id="confirmError" class="text-red-600 text-sm hidden">Passwords do not match</p>
        </div>

        <!-- Submit Button -->
        <button
          id="updateBtn"
          class="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition"
        >
          Update Password
        </button>

        <!-- Back Button -->
        <a href="/user/profile"
          class="bg-gray-200 text-gray-800 text-center py-3 rounded-lg hover:bg-gray-300">
          Back
        </a>

      </form>
    </div>
  </div>
</section>
<!-- 
<script>


function togglePassword(id, btn) {
  const input = document.getElementById(id);

  if (input.type === "password") {
    input.type = "text";
    btn.textContent = "üôà";
  } else {
    input.type = "password";
    btn.textContent = "üëÅÔ∏è";
  }
}

const form = document.getElementById("changePasswordForm");
const currentPwd = document.getElementById("currentPassword");
const newPwd = document.getElementById("newPassword");
const confirmPwd = document.getElementById("confirmPassword");

const currentError = document.getElementById("currentError");
const newError = document.getElementById("newError");
const confirmError = document.getElementById("confirmError");

const updateBtn = document.getElementById("updateBtn");

// Remove error while typing
[currentPwd, newPwd, confirmPwd].forEach((input, i) => {
  input.addEventListener("input", () => {
    [currentError, newError, confirmError][i].classList.add("hidden");
  });
});

form.addEventListener("submit", async function (e) {
  e.preventDefault();
  
  let valid = true;

  if (currentPwd.value.trim() === "") {
    currentError.textContent = "Please enter your current password";
    currentError.classList.remove("hidden");
    valid = false;
  }


  if (newPwd.value.length < 8) {
    newError.textContent = "New password must be at least 8 characters";
    newError.classList.remove("hidden");
    valid = false;
  }

  if (newPwd.value !== confirmPwd.value) {
    confirmError.textContent = "Passwords do not match";
    confirmError.classList.remove("hidden");
    valid = false;
  }

if (currentPwd.value === newPwd.value) {
  newError.textContent = "New password cannot be same as old password";
  newError.classList.remove("hidden");
  return;
}


  if (!valid) return;

  // Disable button
  updateBtn.disabled = true;
  updateBtn.textContent = "Updating...";

  // Send AJAX
  const response = await fetch("/changepassword", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    credentials: "include",
    body: JSON.stringify({
      password: currentPwd.value,
      newpassword: newPwd.value,
      cofirmpassword: confirmPwd.value
    })
  });

  const result = await response.json();

  updateBtn.disabled = false;
  updateBtn.textContent = "Update Password";

  if (!result.success) {
    // Show backend error in UI
    if (result.field === "current") {
      currentError.textContent = result.message;
      currentError.classList.remove("hidden");
    }
    if (result.field === "new") {
      newError.textContent = result.message;
      newError.classList.remove("hidden");
    }
    if (result.field === "confirm") {
      confirmError.textContent = result.message;
      confirmError.classList.remove("hidden");
    }

    Swal.fire({
      icon: "error",
      title: "Update Failed",
      text: result.message
    });

    return;
  }

  Swal.fire({
    icon: "success",
    title: "Password Updated!",
    text: "Your password has been changed successfully.",
    timer: 1500,
    showConfirmButton: false
  }).then(() => {
    window.location.href = "/user/profile";
  });
});




</script> -->

<script>

function togglePassword(id, btn) {
  const input = document.getElementById(id);

  if (input.type === "password") {
    input.type = "text";
    btn.textContent = "üôà";
  } else {
    input.type = "password";
    btn.textContent = "üëÅÔ∏è";
  }
}

const form = document.getElementById("changePasswordForm");
const currentPwd = document.getElementById("currentPassword");
const newPwd = document.getElementById("newPassword");
const confirmPwd = document.getElementById("confirmPassword");

const currentError = document.getElementById("currentError");
const newError = document.getElementById("newError");
const confirmError = document.getElementById("confirmError");

const updateBtn = document.getElementById("updateBtn");

// Remove errors when typing
[currentPwd, newPwd, confirmPwd].forEach((input, i) => {
  input.addEventListener("input", () => {
    [currentError, newError, confirmError][i].classList.add("hidden");
  });
});

form.addEventListener("submit", async function (e) {
  e.preventDefault();

  let valid = true;

  if (currentPwd.value.trim() === "") {
    currentError.textContent = "Please enter your current password";
    currentError.classList.remove("hidden");
    valid = false;
  }

  if (newPwd.value.length < 8) {
    newError.textContent = "New password must be at least 8 characters";
    newError.classList.remove("hidden");
    valid = false;
  }

  if (newPwd.value !== confirmPwd.value) {
    confirmError.textContent = "Passwords do not match";
    confirmError.classList.remove("hidden");
    valid = false;
  }

  if (currentPwd.value === newPwd.value) {
    newError.textContent = "New password cannot be same as old password";
    newError.classList.remove("hidden");
    return;
  }

  if (!valid) return;

  updateBtn.disabled = true;
  updateBtn.textContent = "Updating...";

  const response = await fetch("/changepassword", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      password: currentPwd.value,
      newpassword: newPwd.value,
      cofirmpassword: confirmPwd.value
    })
  });

  const result = await response.json();

  updateBtn.disabled = false;
  updateBtn.textContent = "Update Password";

  if (!result.success) {
    if (result.field === "current") {
      currentError.textContent = result.message;
      currentError.classList.remove("hidden");
    }
    if (result.field === "new") {
      newError.textContent = result.message;
      newError.classList.remove("hidden");
    }
    if (result.field === "confirm") {
      confirmError.textContent = result.message;
      confirmError.classList.remove("hidden");
    }

    Swal.fire({
      icon: "error",
      title: "Update Failed",
      text: result.message
    });

    return;
  }

  // üî• FIXED SWEETALERT SUCCESS BLOCK
  await Swal.fire({
    icon: "success",
    title: "Password Updated!",
    text: "Your password has been changed successfully.",
    confirmButtonText: "OK",
    allowOutsideClick: false
  });

  window.location.href = "/user/profile";
});

</script>



</body>
</html>
