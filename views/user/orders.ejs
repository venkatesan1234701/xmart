<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Orders</title>

  <!-- ‚úÖ Bootstrap only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>

  <style>
    body {
      background-color: #f8fafc;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    .navbar-nav {
      display: flex !important;
      gap: 1rem !important;
    }
    .navbar-nav .nav-link {
      font-weight: 500;
      color: #333 !important;
    }
    .navbar-nav .nav-link:hover {
      color: #0d6efd !important;
    }
    .table th, .table td {
      vertical-align: middle;
    }
  </style>
</head>

<body>

<!-- ‚úÖ Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand text-primary fw-bold" href="/user/profile">Profile</a>
    <ul class="navbar-nav flex-row gap-4 mb-0">
      <li class="nav-item"><a class="nav-link" href="/user/orders">Order History</a></li>
      <li class="nav-item"><a class="nav-link" href="/user/wallet">Wallet</a></li>
      <li class="nav-item"><a class="nav-link" href="/user/add-address">Add Address</a></li>
    </ul>
    <div class="d-flex align-items-center">
      <form id="logoutForm" action="/logout" method="POST" class="me-2 mb-0">
        <button class="btn btn-outline-secondary">Logout</button>
      </form>
      <a class="btn btn-outline-primary" href="/">Home</a>
    </div>
  </div>


</nav>

<!-- ‚úÖ Orders Section -->
<div class="container bg-white p-4 rounded shadow-sm mb-5">
  <!-- üîç Search Bar -->
  <form action="/user/orders" method="get" class="flex gap-2 mb-4">
    <input
      name="search"
      value="<%= search || '' %>"
      class="border border-gray-300 text-gray-900 rounded-lg focus:ring-green-600 focus:ring-1 block p-2 px-3 w-full text-base"
      type="search"
      placeholder="Search by Order ID, Product Name, or Date"
      autocomplete="off"
    />
    <button
      type="submit"
      class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
    >
      Search
    </button>
  </form>

  <h1 class="text-center mb-4 fw-bold text-dark">My Orders</h1>

  <% if (!orders || orders.length === 0) { %>
    <p class="text-muted text-center py-5">
      You haven‚Äôt placed any orders yet.
    </p>
  <% } else { %>
   <div class="table-responsive">
  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Product</th>
        <th>Order ID</th>
        <th>Date</th>
        <th>Order Status</th>
        <th>Payment Status</th> <!-- ‚úÖ Added column -->
        <th>Total</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <% orders.forEach((order, index) => { 
        const firstProduct = order.products[0];
        const firstProductData = firstProduct?.productId;
        const imgToShow =
          firstProductData?.productPic?.[0] ||
          firstProductData?.images?.[0] ||
          firstProductData?.image ||
          "/images/default-product.jpg";
      %>
      <tr>
        <td>
          <div class="d-flex align-items-center gap-3">
            <img
              src="<%= imgToShow %>"
              alt="Product"
              class="rounded border"
              style="width: 64px; height: 64px; object-fit: cover;"
            />
            <div>
              <p class="fw-semibold mb-0">
                <%= firstProductData?.name || 'Unknown Product' %>
              </p>
              <% if (order.products.length > 1) { %>
                <small class="text-muted">
                  +<%= order.products.length - 1 %> more item<%= order.products.length - 1 > 1 ? 's' : '' %>
                </small>
              <% } %>
            </div>
          </div>
        </td>

        <td class="font-monospace"><%= order.orderId %></td>
        <td><%= new Date(order.createdAt).toLocaleDateString() %></td>

        <!-- ‚úÖ Order Status -->
        <td>
          <% if (order.orderStatus === 'Delivered') { %>
            <span class="badge bg-success">Delivered</span>
          <% } else if (order.orderStatus === 'Cancelled') { %>
            <span class="badge bg-danger">Cancelled</span>
          <% } else { %>
            <span class="badge bg-warning text-dark">
              <%= order.orderStatus || 'Processing' %>
            </span>
          <% } %>
        </td>

        <!-- ‚úÖ Payment Status -->
     <td>
  <% if (order.paymentDetails?.status === 'Completed') { %>
    <span class="badge bg-success">Completed</span>
  <% } else if (order.paymentDetails?.status === 'Pending') { %>
    <span class="badge bg-warning text-dark">Pending</span>
  <% } else if (order.paymentDetails?.status === 'Failed') { %>
    <span class="badge bg-danger">Failed</span>
  <% } else if (order.paymentDetails?.status === 'Refunded') { %>
    <span class="badge bg-info text-dark">Refunded</span>
  <% } else if (order.paymentDetails?.status === 'Cancelled') { %>
    <span class="badge bg-dark text-light">Cancelled</span>
  <% } else if (order.paymentDetails?.status === 'Partially Refunded') { %>
    <span class="badge bg-primary text-light">Partially Refunded</span>
  <% } else { %>
    <span class="badge bg-secondary">Unknown</span>
  <% } %>
</td>


        <td class="fw-semibold">‚Çπ<%= order.grandTotal.toFixed(2) %></td>

        <td>
          <button
            class="btn btn-sm btn-outline-primary details-btn"
            data-order-index="<%= index %>"
          >
            Details
          </button>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

    <!-- üì¶ Store all order data in JSON once -->
    <script id="orderData" type="application/json">
      <%- JSON.stringify(orders) %>
    </script>
  <% } %>
</div>



<% if (totalPages > 1) { %>
  <nav class="d-flex justify-content-center mt-4">
    <ul class="pagination">
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
        </li>
      <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
        </li>
      <% } else { %>
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
      <% } %>
    </ul>
  </nav>
<% } %>

<!-- ‚úÖ Modal -->
<!-- üßæ ORDER DETAILS MODAL -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-lg shadow-lg">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Order Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h6 class="font-semibold text-lg mb-3">üßæ Order Info</h6>
        <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
        <p><strong>Payment Method:</strong> <span id="modalPayment"></span></p>
        <p><strong>Status:</strong> <span id="modalStatus"></span></p>
        <p><strong>Total Amount:</strong> ‚Çπ<span id="modalTotal"></span></p>
        <p><strong>Date:</strong> <span id="modalDate"></span></p>

        <hr class="my-3">

        <h6 class="font-semibold text-lg mb-3">üì¶ Products</h6>
        <div id="modalProducts" class="space-y-3"></div>

        <hr class="my-3">

        <h6 class="font-semibold text-lg mb-3">üè† Shipping Address</h6>
        <p id="modalAddress" class="text-sm text-gray-700"></p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" id="downloadInvoiceBtn">
          <i class="bi bi-file-earmark-arrow-down"></i> Download Invoice
        </button>

        <!-- ‚úÖ Repay button (hidden unless failed) -->
        <button class="btn btn-warning d-none" id="repayBtn">
          <i class="bi bi-arrow-repeat"></i> Repay
        </button>

        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
///////////////////////////////////////////////////            this only for dwonload 

document.getElementById("orderDetailsModal").addEventListener("shown.bs.modal", function () {
    const status = document.getElementById("modalStatus").innerText.trim();
    const downloadBtn = document.getElementById("downloadInvoiceBtn");

    if (status === "Cancelled") {
        downloadBtn.style.display = "none";
    } else {
        downloadBtn.style.display = "inline-block";
    }
});

///////////////////////////////////////////////////            



 document.addEventListener("DOMContentLoaded", () => {
     const orders = JSON.parse('<%- JSON.stringify(orders || []) %>');

    document.querySelectorAll(".details-btn").forEach((btn, index) => {
      btn.addEventListener("click", async () => {
        const order = orders[index];

        document.getElementById("modalOrderId").innerText = order.orderId;
        document.getElementById("modalPayment").innerText = order.paymentDetails.method || "N/A";
        document.getElementById("modalStatus").innerText = order.orderStatus;
        document.getElementById("modalTotal").innerText = order.grandTotal;
        document.getElementById("modalDate").innerText = new Date(order.createdAt).toLocaleString();

        const repayBtn = document.getElementById("repayBtn");

        if (order.paymentDetails?.status === "Failed") {
          repayBtn.classList.remove("d-none");
        } else {
          repayBtn.classList.add("d-none");
        }

        repayBtn.onclick = async () => {
          try {
            const res = await fetch("/create-repay-order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ orderId: order.orderId }),
            });

            const data = await res.json();

            if (!data.success) {
              alert("Error creating repayment order!");
              return;
            }

            const options = {
              key: data.key_id,
              amount: data.amount,
              currency: "INR",
              name: "FreshCart",
              description: "Retry Payment",
              order_id: data.razorpayOrderId,
              handler: async function (response) {
                const verifyRes = await fetch("/payment/verify-repay", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    ...response,
                    oldOrderId: order.orderId, 
                  }),
                });

                const result = await verifyRes.text();
                document.open();
                document.write(result);
                document.close();
              },
              theme: { color: "#10b981" },
            };

            const rzp = new Razorpay(options);
            rzp.open();
          } catch (err) {
            console.error(" Repay failed:", err);
            alert("Something went wrong while retrying payment.");
          }
        };

        new bootstrap.Modal(document.getElementById("orderDetailsModal")).show();
      });
    });
  });


// document.getElementById("downloadInvoiceBtn").addEventListener("click", function () {
//   const { jsPDF } = window.jspdf;
//   const doc = new jsPDF();

//   // --- COMPANY INFO ---
//   const companyName = "Xmart";
//   const companyAddress = "From: Olivia Wilson\n123 Anywhere St., Any City";
//   const companyEmail = "hello@xmart.com";

//   doc.setFontSize(16);
//   doc.setTextColor(0, 0, 0);
//   doc.text("Invoice", 14, 20);

//   doc.setFontSize(10);
//   doc.setTextColor(100, 100, 100);
//   doc.text(companyName, 14, 30);
//   doc.text(companyAddress, 14, 35);
//   doc.text(`Email: ${companyEmail}`, 14, 45);

//   // --- ORDER INFO ---
//   const orderId = document.getElementById("modalOrderId")?.innerText || "N/A";
//   const paymentMethod = document.getElementById("modalPayment")?.innerText || "N/A";
//   const status = document.getElementById("modalStatus")?.innerText || "N/A";
//   const total = document.getElementById("modalTotal")?.innerText || "0";
//   const date = document.getElementById("modalDate")?.innerText || "N/A";

//   doc.setTextColor(0, 0, 0);
//   doc.text(`Order ID: ${orderId}`, 140, 30);
//   doc.text(`Order Date: ${date}`, 140, 35);
//   doc.text(`Payment Method: ${paymentMethod}`, 140, 40);
//   doc.text(`Status: ${status}`, 140, 45);
//   doc.text(`Total: ‚Çπ${total}`, 140, 50);

//   // --- PRODUCTS ---
//   const productsMap = {};
//   document.querySelectorAll("#modalProducts div").forEach(item => {
//     const name = item.querySelector("strong")?.innerText || "Unknown";
//     const qtyMatch = item.innerText.match(/Qty:\s*(\d+)/);
//     const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;
//     const pStatus = item.dataset.status || "Delivery";

//     if (productsMap[name]) {
//       productsMap[name].qty += qty;
//       if (!productsMap[name].status.includes(pStatus)) productsMap[name].status += ", " + pStatus;
//     } else {
//       productsMap[name] = { qty, status: pStatus };
//     }
//   });

//   const tableBody = Object.entries(productsMap).map(([name, data], idx) => [
//     idx + 1,
//     name,
//     data.qty,
//     data.status,
//     "" // Total column left blank
//   ]);

//   doc.autoTable({
//     startY: 60,
//     head: [['#', 'Product', 'Qty', 'Status']],
//     body: tableBody,
//     theme: 'grid',
//     headStyles: { fillColor: [41, 128, 185], textColor: 255 },
//     styles: { fontSize: 10, cellPadding: 5 },
//     margin: { left: 14, right: 14 }
//   });

//   // --- SHIPPING ADDRESS ---
//   const address = document.getElementById("modalAddress")?.innerText || "N/A";
//   const startY = doc.lastAutoTable.finalY + 10;
//   doc.setFontSize(10);
//   doc.text("üè† Shipping Address:", 14, startY);
//   address.split("\n").forEach((line, i) => doc.text(line.trim(), 14, startY + 7 + i * 6));

//   // --- SUMMARY ---
//   const summaryStartY = startY + 30;
//   doc.text(`Amount to Pay: ‚Çπ${total}`, 140, summaryStartY);
//   doc.text(`Payment Method: ${paymentMethod}`, 140, summaryStartY + 7);
//   doc.text(`Status: ${status}`, 140, summaryStartY + 14);

//   // --- FOOTER ---
//   doc.setFontSize(8);
//   doc.setTextColor(150, 150, 150);
//   doc.text("Thank you for shopping with Xmart!", 14, doc.internal.pageSize.height - 10);
//   doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 140, doc.internal.pageSize.height - 10);

//   doc.save(`Invoice_${orderId.replace(/[^a-zA-Z0-9]/g, "")}_${Date.now()}.pdf`);
// });



document.getElementById("downloadInvoiceBtn").addEventListener("click", function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // --- COMPANY INFO ---
  const companyName = "Xmart";
  const companyAddress = "From: Olivia Wilson\n123 Anywhere St., Any City";
  const companyEmail = "hello@xmart.com";

  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text("Invoice", 14, 20);

  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text(companyName, 14, 30);
  doc.text(companyAddress, 14, 35);
  doc.text(`Email: ${companyEmail}`, 14, 45);

  // --- ORDER INFO ---
  const orderId = document.getElementById("modalOrderId")?.innerText || "N/A";
  const paymentMethod = document.getElementById("modalPayment")?.innerText || "N/A";
  const status = document.getElementById("modalStatus")?.innerText || "N/A";
  const total = parseFloat(document.getElementById("modalTotal")?.innerText) || 0;
  const date = document.getElementById("modalDate")?.innerText || "N/A";

  doc.setTextColor(0, 0, 0);
  doc.text(`Order ID: ${orderId}`, 140, 30);
  doc.text(`Order Date: ${date}`, 140, 35);
  doc.text(`Payment Method: ${paymentMethod}`, 140, 40);
  doc.text(`Status: ${status}`, 140, 45);
  doc.text(`Total: ‚Çπ${total}`, 140, 50);

  // --- PRODUCTS ---
  const productsMap = {};
  document.querySelectorAll("#modalProducts > div").forEach(item => {
    const nameTag = item.querySelector("strong") || item.querySelector(".product-name");
    const productName = nameTag?.innerText.trim() || "Unknown Product";

    const qtyMatch = item.innerText.match(/Qty:\s*(\d+)/);
    const qty = qtyMatch ? parseInt(qtyMatch[1]) : 1;

    const statusValue = item.dataset.status || "Delivery";

    const totalMatch = item.innerText.match(/Total:\s*‚Çπ?(\d+(\.\d+)?)/);
    const productTotal = totalMatch ? parseFloat(totalMatch[1]) : 0;

    if (!productsMap[productName]) {
      productsMap[productName] = {
        qty,
        status: statusValue,
        total: productTotal
      };
    } else {
      productsMap[productName].qty += qty;
      productsMap[productName].total += productTotal;
      const stArr = productsMap[productName].status.split(",").map(s => s.trim());
      if (!stArr.includes(statusValue)) stArr.push(statusValue);
      productsMap[productName].status = stArr.join(", ");
    }
  });

  const tableBody = Object.entries(productsMap).map(([name, data], idx) => [
    idx + 1,
    name,
    data.qty,
    data.status,
    `‚Çπ${data.total}`
  ]);

  doc.autoTable({
    startY: 60,
    head: [['#', 'Product', 'Qty', 'Status']],
    body: tableBody,
    theme: 'grid',
    headStyles: { fillColor: [41, 128, 185], textColor: 255 },
    styles: { fontSize: 10, cellPadding: 5 },
    margin: { left: 14, right: 14 }
  });

  // --- GRAND TOTAL BELOW TABLE ---
  const grandTotalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(`Grand Total: ‚Çπ${total}`, 150, grandTotalY, { align: "right" });

  // --- SHIPPING ADDRESS ---
  const address = document.getElementById("modalAddress")?.innerText || "N/A";
  const addressStartY = grandTotalY + 10;
  doc.setFontSize(10);
  doc.text("üè† Shipping Address:", 14, addressStartY);
  address.split("\n").forEach((line, i) => doc.text(line.trim(), 14, addressStartY + 7 + i * 6));

  // --- FOOTER ---
  const footerY = doc.internal.pageSize.height - 10;
  doc.setFontSize(8);
  doc.setTextColor(150, 150, 150);
  doc.text("Thank you for shopping with Xmart!", 14, footerY);
  doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 140, footerY);

  // --- SAVE PDF ---
  doc.save(`Invoice_${orderId.replace(/[^a-zA-Z0-9]/g, "")}_${Date.now()}.pdf`);
});



document.addEventListener("DOMContentLoaded", () => {
  const orders = JSON.parse(document.getElementById("orderData")?.textContent || "[]");
  const modal = new bootstrap.Modal(document.getElementById("orderDetailsModal"));
  let currentOrder = null;

  // üü¢ Handle "Details" button click
  document.querySelectorAll(".details-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const order = orders[btn.dataset.orderIndex];
      currentOrder = order;
      showOrderDetails(order);
      modal.show();
    });
  });

  // üßæ Show order details inside modal
//   function showOrderDetails(order) {
//     document.getElementById("modalOrderId").innerText = order.orderId;
//     document.getElementById("modalPayment").innerText = order.paymentMethod || "N/A";
//     document.getElementById("modalStatus").innerText = order.orderStatus;
//     document.getElementById("modalTotal").innerText = order.grandTotal;
//     document.getElementById("modalDate").innerText = new Date(order.createdAt).toLocaleString();

//     // üè† Shipping address
//     const addr = order.shippingAddress;
//     document.getElementById("modalAddress").innerHTML = addr
//       ? `${addr.firstName || ""} ${addr.lastName || ""}<br>${addr.addressLine1 || ""}<br>${addr.city || ""}, ${addr.state || ""} - ${addr.zipCode || ""}`
//       : "No address available.";

//     // üõí Product list
//     const productsContainer = document.getElementById("modalProducts");
//     productsContainer.innerHTML = "";

//     order.products.forEach(item => {
//       const prod = item.productId || {};
//       const img = prod.productPic?.[0] || prod.images?.[0] || prod.image || "/images/default-product.jpg";

//    order.products.forEach(item => {
//   const prod = item.productId || {};
//   const img = prod.productPic?.[0] || prod.images?.[0] || prod.image || "/images/default-product.jpg";

//   let actionBtns = "";

//   const itemStatus = item.itemStatus;      // item-level status
//   const orderStatus = order.orderStatus;  // overall order status

//   // 1Ô∏è‚É£ Already Returned ‚Üí only Returned badge
//   if (itemStatus === "Returned") {
//     actionBtns = `<span class="badge bg-secondary">Returned</span>`;
//   }

//   // 2Ô∏è‚É£ Already Cancelled ‚Üí only Cancelled badge
//   else if (itemStatus === "Cancelled") {
//     actionBtns = `<span class="badge bg-danger">Cancelled</span>`;
//   }

//   // 3Ô∏è‚É£ Order Delivered ‚Üí show Return button (only if item not returned/cancelled earlier)
//   else if (orderStatus === "Delivered") {
//     actionBtns = `
//       <button class="btn btn-sm btn-outline-warning"
//         onclick="returnProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
//           Return
//       </button>`;
//   }

//   // 4Ô∏è‚É£ Order not delivered ‚Üí show Cancel button
//   else {
//     actionBtns = `
//       <button class="btn btn-sm btn-outline-danger"
//         onclick="cancelProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
//           Cancel
//       </button>`;
//   }

//   // ---- PRODUCT HTML UI ----
//   const productHtml = `
//     <div class="d-flex align-items-center justify-content-between border p-2 rounded mb-2">
//       <div class="d-flex align-items-center gap-3">
//         <img src="${img}" width="60" height="60" class="rounded border" style="object-fit:cover;">
//         <div>
//           <p class="fw-semibold mb-1">${prod.name || "Product"}</p>
//           <small class="text-muted">Size: ${item.selectedSize || "-"} | Qty: ${item.quantity}</small><br>
//           <small class="text-muted">‚Çπ${item.paidPrice ?? item.totalPrice}</small>
//         </div>
//       </div>
//       <div>${actionBtns}</div>
//     </div>`;

//   productsContainer.insertAdjacentHTML("beforeend", productHtml);
// });

//     });

//     // üß© Hide Cancel Order button if Delivered or Cancelled
//     const cancelOrderBtn = document.getElementById("cancelOrderBtn");
//     if (order.orderStatus === "Delivered" || order.orderStatus === "Cancelled") {
//       cancelOrderBtn.style.display = "none";
//     } else {
//       cancelOrderBtn.style.display = "inline-block";
//     }
//   }


function showOrderDetails(order) {
  document.getElementById("modalOrderId").innerText = order.orderId;
  document.getElementById("modalPayment").innerText = order.paymentMethod || "N/A";
  document.getElementById("modalStatus").innerText = order.orderStatus;
  document.getElementById("modalTotal").innerText = order.grandTotal;
  document.getElementById("modalDate").innerText = new Date(order.createdAt).toLocaleString();

  // Address
  const addr = order.shippingAddress;
  document.getElementById("modalAddress").innerHTML = addr
    ? `${addr.firstName || ""} ${addr.lastName || ""}<br>${addr.addressLine1 || ""}<br>${addr.city || ""}, ${addr.state || ""} - ${addr.zipCode || ""}`
    : "No address available.";

  const productsContainer = document.getElementById("modalProducts");
  productsContainer.innerHTML = "";

  // üöÄ ONLY ONE LOOP ‚Äî FIXED
  order.products.forEach(item => {
    const prod = item.productId || {};
    const img = prod.productPic?.[0] || prod.images?.[0] || prod.image || "/images/default-product.jpg";

    let actionBtns = "";
    const itemStatus = item.itemStatus;
    const orderStatus = order.orderStatus;

    // ---------------------------
    // üöÄ ITEM STATUS BASED BUTTONS
    // ---------------------------

    // if (itemStatus === "Returned") {
    //   actionBtns = `<span class="badge bg-secondary">Returned</span>`;
    // }
    // else if (itemStatus === "Cancelled") {
    //   actionBtns = `<span class="badge bg-danger">Cancelled</span>`;
    // }
    // else if (orderStatus === "Delivered") {
    //   actionBtns = `
    //     <button class="btn btn-sm btn-outline-warning"
    //       onclick="returnProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
    //         Return
    //     </button>`;
    // }
    // else {
    //   actionBtns = `
    //     <button class="btn btn-sm btn-outline-danger"
    //       onclick="cancelProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
    //         Cancel
    //     </button>`;
    // }

    if (itemStatus === "Returned") {
  actionBtns = `<span class="badge bg-secondary">Returned</span>`;
} else if (itemStatus === "Cancelled") {
  actionBtns = `<span class="badge bg-danger">Cancelled</span>`;
} else if(itemStatus === "Returning"){
  actionBtns = `<span class="badge bg-danger">Returning</span>`;
}
else if (orderStatus === "Delivered") {
  actionBtns = `
    <button class="btn btn-sm btn-outline-warning"
      onclick="returnProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
      Return
    </button>`;
} else {
  actionBtns = `
    <button class="btn btn-sm btn-outline-danger"
      onclick="cancelProduct('${order._id}', '${item.productId._id}', '${item.selectedSize}')">
      Cancel
    </button>`;
}


    // PRODUCT HTML
    const productHtml = `
      <div class="d-flex align-items-center justify-content-between border p-2 rounded mb-2">
        <div class="d-flex align-items-center gap-3">
          <img src="${img}" width="60" height="60" class="rounded border" style="object-fit:cover;">
          <div>
            <p class="fw-semibold mb-1">${prod.name || "Product"}</p>
            <small class="text-muted">Size: ${item.selectedSize || "-"} | Qty: ${item.quantity}</small><br>
            <small class="text-muted">‚Çπ${item.paidPrice ?? item.totalPrice}</small>
          </div>
        </div>
        <div>${actionBtns}</div>
      </div>`;

    productsContainer.insertAdjacentHTML("beforeend", productHtml);
  });

  // Entire Order Cancel Button
  const cancelOrderBtn = document.getElementById("cancelOrderBtn");
  if (order.orderStatus === "Delivered" || order.orderStatus === "Cancelled") {
    cancelOrderBtn.style.display = "none";
  } else {
    cancelOrderBtn.style.display = "inline-block";
  }
}


  
  // ‚ùå Cancel entire order
  document.getElementById("cancelOrderBtn").addEventListener("click", async () => {
    if (!currentOrder?._id) return;

    const confirm = await Swal.fire({
      title: "Cancel this entire order?",
      text: "Once cancelled, this cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, cancel it",
      cancelButtonText: "No, keep it"
    });
    if (!confirm.isConfirmed) return;

    try {
      const res = await fetch(`/user/orders/${currentOrder._id}/cancel`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
      });

      if (res.ok) {
        await Swal.fire("‚úÖ Cancelled!", "Your order has been cancelled successfully.", "success");
        location.reload();
      } else {
        const data = await res.json();
        Swal.fire("‚ùå Error", data.message || "Failed to cancel order.", "error");
      }
    } catch (error) {
      console.error("Cancel Order Error:", error);
      Swal.fire("‚ùå Error", "Something went wrong while cancelling.", "error");
    }
  });
});

// ‚úÖ Cancel specific product
async function cancelProduct(orderId, productId, size) {
  const confirm = await Swal.fire({
    title: "Cancel this product?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, cancel it"
  });
  if (!confirm.isConfirmed) return;

  const res = await fetch(`/user/orders/${orderId}/cancel-item`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ productId, selectedSize: size })
  });

  const data = await res.json();
  if (res.ok) {
    await Swal.fire("‚úÖ Cancelled!", data.message, "success");
    location.reload();
  } else {
    Swal.fire("‚ùå Error", data.message || "Failed to cancel product.", "error");
  }
}

// ‚úÖ Return specific product

// async function returnProduct(orderId, productId, size) {
//   const confirm = await Swal.fire({
//     title: "Return this product?",
//     icon: "warning",
//     showCancelButton: true,
//     confirmButtonText: "Yes, return it"
//   });
//   if (!confirm.isConfirmed) return;

//   const res = await fetch(`/user/orders/${orderId}/return-item`, {
//     method: "PUT",
//     headers: { "Content-Type": "application/json" },
//     body: JSON.stringify({ productId, selectedSize: size })
//   });

//   const data = await res.json();
//   if (res.ok) {
//     await Swal.fire("‚úÖ Returned!", data.message, "success");
//     location.reload();
//   } else {
//     Swal.fire("‚ùå Error", data.message || "Failed to return product.", "error");
//   }
// }


async function returnProduct(orderId, productId, size) {
  const confirm = await Swal.fire({
    title: "Return this product?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Yes, return it"
  });
  if (!confirm.isConfirmed) return;

  const res = await fetch(`/user/orders/${orderId}/return-item`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ productId, selectedSize: size })
  });

  const data = await res.json();
  if (res.ok) {
    await Swal.fire("‚úÖ Return Requested!", data.message, "success");
    location.reload();
  } else {
    Swal.fire("‚ùå Error", data.message || "Failed to return product.", "error");
  }
}


</script>

</body>
</html>